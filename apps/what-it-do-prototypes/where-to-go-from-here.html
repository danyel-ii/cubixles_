<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>cubixles_ - where to go from here</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Caveat:wght@600&family=Space+Grotesk:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap");
    @font-face {
      font-family: "Cubixles Logo";
      src:
        url("/assets/fonts/cubixles-logo.woff2") format("woff2"),
        url("/assets/fonts/cubixles-logo.woff") format("woff"),
        url("/assets/fonts/cubixles-logo.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root {
      color-scheme: light;
      --paper: #ffffff;
      --paper-warm: #fff7ee;
      --ink: #000000;
      --ink-muted: rgba(0, 0, 0, 0.7);
      --ink-soft: rgba(0, 0, 0, 0.55);
      --line: #000000;
      --line-strong: #000000;
      --palette-1: #FFEAD3;
      --palette-2: #EA7B7B;
      --palette-3: #D25353;
      --palette-4: #9E3B3B;
      --palette-3-rgb: 210, 83, 83;
      --neon-magenta: var(--palette-3);
      --neon-magenta-rgb: var(--palette-3-rgb);
      --neon-magenta-glow: rgba(var(--neon-magenta-rgb), 0.4);
      --shadow-soft: 12px 12px 0 rgba(0, 0, 0, 0.95);
      --shadow-tight: 6px 6px 0 rgba(0, 0, 0, 0.95);
      --font-body: "Space Grotesk", sans-serif;
      --font-display: "Space Grotesk", var(--font-body);
      --font-logo: "Cubixles Logo", var(--font-body);
      --font-mono: "Space Mono", monospace;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: var(--font-body);
      color: var(--ink);
      background:
        radial-gradient(ellipse at 20% 10%, rgba(255, 255, 255, 0.92) 0%, transparent 45%),
        radial-gradient(ellipse at 80% 20%, rgba(255, 255, 255, 0.8) 0%, transparent 48%),
        radial-gradient(ellipse at 60% 100%, rgba(var(--neon-magenta-rgb), 0.12) 0%, transparent 55%),
        repeating-linear-gradient(
          90deg,
          rgba(0, 0, 0, 0.08) 0,
          rgba(0, 0, 0, 0.08) 1px,
          transparent 1px,
          transparent 24px
        ),
        repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.08) 0,
          rgba(0, 0, 0, 0.08) 1px,
          transparent 1px,
          transparent 24px
        ),
        var(--paper);
      background-attachment: fixed;
    }

    .page {
      min-height: 100%;
      padding: 28px clamp(18px, 3vw, 48px) 64px;
      display: flex;
      flex-direction: column;
      gap: 40px;
    }

    .scene {
      border: 3px solid var(--line-strong);
      background: var(--paper-warm);
      box-shadow: var(--shadow-soft);
      padding: clamp(16px, 2vw, 22px);
      display: grid;
      gap: 16px;
      position: relative;
      overflow: hidden;
    }

    .scene::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 12% 12%, rgba(var(--neon-magenta-rgb), 0.18), transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(var(--neon-magenta-rgb), 0.12), transparent 55%);
      opacity: 0.6;
      pointer-events: none;
    }

    .scene > * {
      position: relative;
      z-index: 1;
    }

    .scene-top {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .scene-brand {
      border: 3px solid var(--line-strong);
      background: #ffffff;
      padding: 12px 14px;
      box-shadow: var(--shadow-tight);
      max-width: 520px;
      display: grid;
      gap: 6px;
    }

    .scene-brand p {
      margin: 0;
      font-size: 12.5px;
      color: var(--ink-muted);
    }

    .scene-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .scene-pill {
      border: 3px solid var(--line-strong);
      background: #ffffff;
      padding: 6px 10px;
      box-shadow: var(--shadow-tight);
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-weight: 700;
      cursor: pointer;
    }

    .scene-pill .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #ffffff;
      border: 2px solid var(--line-strong);
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.12);
    }

    .scene-pill.is-on .dot {
      background: var(--neon-magenta);
      box-shadow: 0 0 0 4px rgba(var(--neon-magenta-rgb), 0.25);
    }

    .scene-pill .state {
      font-size: 10px;
      letter-spacing: 0.1em;
      padding: 2px 6px;
      border: 2px solid var(--line-strong);
      background: var(--paper-warm);
    }

    .scene-body {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 300px;
      gap: 16px;
      align-items: stretch;
    }

    .scene-viewport {
      position: relative;
      border: 3px solid var(--line-strong);
      background: linear-gradient(180deg, #fff 0%, #f9eee3 60%, #f7e7de 100%);
      box-shadow: var(--shadow-tight);
      overflow: hidden;
      isolation: isolate;
      height: clamp(360px, 52vh, 560px);
    }

    .scene-sky {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        180deg,
        var(--sky-top, #fff) 0%,
        var(--sky-mid, #fef4ec) 55%,
        var(--sky-bottom, rgba(255, 255, 255, 0.2)) 100%
      );
      z-index: 0;
      transition: background 0.6s ease;
    }

    .scene-sky::after {
      content: "";
      position: absolute;
      right: 12%;
      top: 12%;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(var(--neon-magenta-rgb), 0.35), transparent 65%);
      opacity: 0.5;
    }

    .scene-sky .sun,
    .scene-sky .moon {
      position: absolute;
      width: 88px;
      height: 88px;
      border-radius: 50%;
      border: 2px solid rgba(0, 0, 0, 0.2);
      background: radial-gradient(circle, #fff, rgba(255, 255, 255, 0.1) 70%);
      box-shadow: 0 0 28px rgba(var(--neon-magenta-rgb), 0.25);
      transform: translate(-50%, -50%);
      transition: opacity 0.6s ease;
    }

    .scene-sky .moon {
      width: 64px;
      height: 64px;
      background: radial-gradient(circle, #f7f7ff, rgba(255, 255, 255, 0.2) 70%);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
    }

    .scene-sky .cloud {
      position: absolute;
      left: var(--x);
      top: var(--y);
      width: var(--w);
      height: var(--h);
      background: rgba(255, 255, 255, 0.92);
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-radius: 999px;
      box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.05);
      animation: drift var(--speed) linear infinite;
    }

    .scene-world {
      position: absolute;
      left: 0;
      top: 0;
      width: 1400px;
      height: 900px;
      background:
        radial-gradient(circle at 20% 20%, rgba(var(--neon-magenta-rgb), 0.06), transparent 45%),
        radial-gradient(circle at 70% 60%, rgba(0, 0, 0, 0.05), transparent 50%),
        repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.06) 0,
          rgba(0, 0, 0, 0.06) 1px,
          transparent 1px,
          transparent 26px
        ),
        repeating-linear-gradient(
          90deg,
          rgba(0, 0, 0, 0.06) 0,
          rgba(0, 0, 0, 0.06) 1px,
          transparent 1px,
          transparent 26px
        ),
        #f9efe6;
      z-index: 1;
      --wind: 0.4;
    }

    .scene-world[data-season="spring"] {
      filter: saturate(1.08);
    }

    .scene-world[data-season="summer"] {
      filter: saturate(1.12) brightness(1.02);
    }

    .scene-world[data-season="autumn"] {
      filter: saturate(0.95) sepia(0.1);
    }

    .scene-world[data-season="winter"] {
      filter: saturate(0.85) brightness(1.04);
    }

    .scene-world::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(rgba(0, 0, 0, 0.08) 1px, transparent 1px);
      background-size: 18px 18px;
      opacity: 0.22;
      pointer-events: none;
    }

    .scene-track {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    .scene-light,
    .scene-fog,
    .scene-lightning,
    .scene-fx {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .scene-light {
      background: radial-gradient(circle at 40% 20%, rgba(255, 255, 255, 0.55), transparent 55%);
      opacity: 0;
      z-index: 2;
      transition: opacity 0.6s ease;
      mix-blend-mode: multiply;
    }

    .scene-fog {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.0) 0%, rgba(255, 255, 255, 0.7) 100%);
      opacity: 0;
      z-index: 2;
      transition: opacity 0.4s ease;
    }

    .scene-lightning {
      background: rgba(255, 255, 255, 0.85);
      opacity: 0;
      z-index: 3;
      transition: opacity 0.2s ease;
      mix-blend-mode: screen;
    }

    .scene-fx {
      width: 100%;
      height: 100%;
      z-index: 3;
    }

    .terrain {
      position: absolute;
      left: var(--x);
      top: var(--y);
      width: var(--w);
      height: var(--h);
      border: 2px solid rgba(0, 0, 0, 0.65);
      background: rgba(255, 255, 255, 0.65);
      border-radius: 42% 58% 46% 54%;
      opacity: 0.9;
      transform: rotate(var(--r, 0deg));
      box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.08);
    }

    .terrain.ridge {
      background: rgba(var(--neon-magenta-rgb), 0.08);
    }

    .terrain.lake {
      background: rgba(0, 0, 0, 0.04);
      border-style: dashed;
    }

    .prop {
      position: absolute;
      left: var(--x);
      top: var(--y);
      transform: translate(-50%, -50%);
      border: 2px solid rgba(0, 0, 0, 0.7);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.08);
      z-index: 2;
    }

    .prop.bench {
      width: 64px;
      height: 18px;
      border-radius: 8px;
    }

    .prop.fence {
      width: 84px;
      height: 16px;
      background: repeating-linear-gradient(
        90deg,
        rgba(0, 0, 0, 0.1) 0,
        rgba(0, 0, 0, 0.1) 10px,
        transparent 10px,
        transparent 18px
      );
    }

    .prop.lantern {
      width: 18px;
      height: 50px;
      border-radius: 8px;
      background: #ffffff;
      position: absolute;
    }

    .prop.lantern::after {
      content: "";
      position: absolute;
      left: 50%;
      top: -22px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(var(--neon-magenta-rgb), 0.35), transparent 70%);
      transform: translateX(-50%);
      opacity: 0.6;
      animation: lantern-flicker 2.6s ease-in-out infinite;
    }

    .prop.bricks {
      width: 70px;
      height: 40px;
      background: repeating-linear-gradient(
        90deg,
        rgba(0, 0, 0, 0.12) 0,
        rgba(0, 0, 0, 0.12) 12px,
        transparent 12px,
        transparent 20px
      );
    }

    .prop.signpost {
      width: 20px;
      height: 48px;
      border-radius: 6px;
    }

    .prop.signpost::after {
      content: "";
      position: absolute;
      left: -22px;
      top: -8px;
      width: 58px;
      height: 26px;
      border: 2px solid rgba(0, 0, 0, 0.7);
      background: rgba(255, 255, 255, 0.9);
      transform: rotate(-8deg);
    }

    .prop.tree {
      width: 26px;
      height: 44px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.05);
    }

    .prop.tree::before {
      content: "";
      position: absolute;
      left: 50%;
      top: -28px;
      width: 60px;
      height: 40px;
      border-radius: 999px;
      border: 2px solid rgba(0, 0, 0, 0.6);
      background: rgba(var(--neon-magenta-rgb), 0.18);
      transform: translateX(-50%);
      box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.08);
    }

    .grass-patch {
      position: absolute;
      left: var(--x);
      top: var(--y);
      width: var(--w);
      height: var(--h);
      transform: translate(-50%, -50%);
      background: repeating-linear-gradient(
        90deg,
        rgba(0, 0, 0, 0.1) 0,
        rgba(0, 0, 0, 0.1) 2px,
        transparent 2px,
        transparent 8px
      );
      border: 2px solid rgba(0, 0, 0, 0.5);
      opacity: 0.5;
    }

    .water {
      position: absolute;
      left: var(--x);
      top: var(--y);
      width: var(--w);
      height: var(--h);
      transform: translate(-50%, -50%);
      border: 2px solid rgba(0, 0, 0, 0.7);
      border-radius: 18px;
      background: repeating-linear-gradient(
        45deg,
        rgba(var(--neon-magenta-rgb), 0.12) 0,
        rgba(var(--neon-magenta-rgb), 0.12) 6px,
        rgba(255, 255, 255, 0.4) 6px,
        rgba(255, 255, 255, 0.4) 12px
      );
      box-shadow: inset 0 0 18px rgba(0, 0, 0, 0.08);
    }

    .leaf {
      position: absolute;
      left: var(--x);
      top: var(--y);
      width: 10px;
      height: 6px;
      border-radius: 999px;
      background: rgba(var(--neon-magenta-rgb), 0.45);
      border: 1px solid rgba(0, 0, 0, 0.4);
      transform: translate(-50%, -50%);
      animation: leaf-drift var(--duration, 5s) ease-in-out infinite;
    }

    .tornado {
      position: absolute;
      left: var(--x);
      top: var(--y);
      width: 120px;
      height: 180px;
      transform: translate(-50%, -60%);
      border: 2px dashed rgba(0, 0, 0, 0.5);
      border-radius: 50% 50% 40% 40%;
      background: radial-gradient(circle, rgba(var(--neon-magenta-rgb), 0.18), transparent 70%);
      opacity: 0.0;
      transition: opacity 0.3s ease;
      z-index: 2;
    }

    .tornado::before,
    .tornado::after {
      content: "";
      position: absolute;
      inset: 12px;
      border: 2px dashed rgba(0, 0, 0, 0.4);
      border-radius: 50%;
      animation: tornado-spin 4s linear infinite;
    }

    .tornado::after {
      inset: 24px;
      animation-duration: 2.8s;
    }

    .tornado.is-visible {
      opacity: 0.35;
    }

    .tornado.is-active {
      opacity: 0.7;
    }

    .tornado .core {
      position: absolute;
      left: 50%;
      bottom: 10px;
      width: 32px;
      height: 32px;
      transform: translateX(-50%);
      border-radius: 50%;
      border: 2px solid rgba(0, 0, 0, 0.6);
      background: rgba(var(--neon-magenta-rgb), 0.25);
    }

    .road {
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }

    .road path {
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .road .road-base {
      stroke: rgba(0, 0, 0, 0.85);
      stroke-width: 84;
    }

    .road .road-inner {
      stroke: rgba(255, 255, 255, 0.9);
      stroke-width: 60;
    }

    .road .road-lane {
      stroke: var(--neon-magenta);
      stroke-width: 6;
      stroke-dasharray: 24 16;
      opacity: 0.7;
    }

    .object {
      position: absolute;
      width: 72px;
      height: 72px;
      border: 3px solid var(--line-strong);
      background: #ffffff;
      box-shadow: var(--shadow-tight);
      display: grid;
      place-items: center;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 9.5px;
      font-weight: 700;
      transform: translate(-50%, -50%);
      z-index: 4;
    }

    .object::after {
      content: "";
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 24px;
      background: #ffffff;
      border: 3px solid var(--line-strong);
      border-top: 0;
    }

    .object .obj-label {
      padding: 2px 6px;
      border: 2px solid var(--line-strong);
      background: var(--paper-warm);
    }

    .object.is-near {
      box-shadow: 0 0 20px rgba(var(--neon-magenta-rgb), 0.5);
      border-color: var(--neon-magenta);
    }

    .object.is-visited {
      background: rgba(var(--neon-magenta-rgb), 0.12);
    }

    .object.billboard {
      width: 108px;
      height: 64px;
    }

    .object.tower {
      width: 64px;
      height: 120px;
    }

    .object.tower::after {
      height: 10px;
      bottom: -10px;
    }

    .object.ramp {
      width: 90px;
      height: 36px;
      transform: translate(-50%, -50%) skewX(-12deg);
    }

    .object.garage {
      width: 120px;
      height: 72px;
    }

    .object.bridge {
      width: 140px;
      height: 44px;
      background: repeating-linear-gradient(
        90deg,
        rgba(var(--neon-magenta-rgb), 0.2) 0,
        rgba(var(--neon-magenta-rgb), 0.2) 10px,
        transparent 10px,
        transparent 20px
      );
    }

    .object.relay {
      width: 78px;
      height: 78px;
      border-radius: 12px;
    }

    .object.relay::before {
      content: "";
      position: absolute;
      inset: 10px;
      border: 2px dashed var(--line-strong);
      border-radius: 10px;
    }

    .object.crate {
      width: 64px;
      height: 64px;
      background: rgba(0, 0, 0, 0.04);
    }

    .object.explosive {
      background: rgba(var(--neon-magenta-rgb), 0.18);
      border-style: dashed;
    }

    .object.explosive::before {
      content: "";
      position: absolute;
      inset: 10px;
      border: 2px solid rgba(0, 0, 0, 0.5);
      border-radius: 8px;
    }

    .object.explosive.is-exploding {
      animation: explode 0.4s ease;
      background: rgba(var(--neon-magenta-rgb), 0.45);
      box-shadow: 0 0 30px rgba(var(--neon-magenta-rgb), 0.6);
    }

    .object.explosive.is-exploding::after {
      content: "";
      position: absolute;
      inset: -24px;
      border-radius: 50%;
      border: 3px solid rgba(var(--neon-magenta-rgb), 0.6);
      animation: boom 0.4s ease-out;
    }

    .float-cube {
      position: absolute;
      left: var(--x);
      top: var(--y);
      width: var(--size);
      height: var(--size);
      border: 2px solid var(--line-strong);
      background: rgba(var(--neon-magenta-rgb), 0.18);
      transform: translate(-50%, -50%) rotate(12deg);
      animation: float 6s ease-in-out infinite;
      animation-delay: var(--delay);
      z-index: 1;
      box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.12);
    }

    .player {
      position: absolute;
      width: 34px;
      height: 34px;
      border: 3px solid var(--line-strong);
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 0 16px rgba(var(--neon-magenta-rgb), 0.45);
      z-index: 3;
    }

    .player::before {
      content: "";
      position: absolute;
      inset: 6px;
      border: 2px solid var(--line-strong);
      background: rgba(var(--neon-magenta-rgb), 0.25);
      border-radius: 6px;
    }

    .player.is-boost {
      box-shadow: 0 0 30px rgba(var(--neon-magenta-rgb), 0.55);
    }

    .player.is-hop {
      animation: hop 320ms ease;
    }

    .scene-hud {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 3;
    }

    .scene-hint {
      position: absolute;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      border: 2px solid var(--line-strong);
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 180ms ease;
    }

    .scene-hint.is-visible {
      opacity: 1;
    }

    .scene-speed {
      position: absolute;
      right: 12px;
      top: 12px;
      border: 2px solid var(--line-strong);
      background: #ffffff;
      padding: 4px 8px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .scene-status {
      position: absolute;
      left: 12px;
      bottom: 12px;
      border: 2px solid var(--line-strong);
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      box-shadow: var(--shadow-tight);
    }

    .scene-telemetry {
      position: absolute;
      right: 12px;
      bottom: 206px;
      border: 2px solid var(--line-strong);
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      box-shadow: var(--shadow-tight);
    }

    .scene-toast {
      position: absolute;
      left: 12px;
      top: 12px;
      display: grid;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      pointer-events: none;
    }

    .scene-toast .toast {
      border: 2px solid var(--line-strong);
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      box-shadow: var(--shadow-tight);
    }

    .scene-map {
      position: absolute;
      right: 12px;
      bottom: 12px;
      width: 180px;
      height: 180px;
      border: 3px solid var(--line-strong);
      background: rgba(255, 255, 255, 0.9);
      display: none;
      box-shadow: var(--shadow-tight);
    }

    .scene-map.is-visible {
      display: block;
    }

    .scene-map canvas {
      width: 100%;
      height: 100%;
    }

    .scene-map .map-label {
      position: absolute;
      left: 8px;
      top: 6px;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .scene-scanlines {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.05) 0,
        rgba(0, 0, 0, 0.05) 1px,
        transparent 1px,
        transparent 3px
      );
      opacity: 0.12;
      pointer-events: none;
      z-index: 4;
    }

    .scene-side {
      display: grid;
      gap: 12px;
      align-content: start;
    }

    .scene-panel {
      border: 3px solid var(--line-strong);
      background: #ffffff;
      padding: 12px;
      box-shadow: var(--shadow-tight);
      display: grid;
      gap: 10px;
      font-size: 12px;
      color: var(--ink-muted);
    }

    .scene-panel h3 {
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--ink);
    }

    .control-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .kbd {
      border: 2px solid var(--line-strong);
      background: var(--paper-warm);
      padding: 2px 6px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--ink);
    }

    .achievement {
      display: grid;
      gap: 6px;
    }

    .achievement-bar {
      height: 6px;
      border: 2px solid var(--line-strong);
      background: rgba(0, 0, 0, 0.06);
      position: relative;
      overflow: hidden;
    }

    .achievement-bar span {
      display: block;
      height: 100%;
      width: 0%;
      background: var(--neon-magenta);
      transition: width 220ms ease;
    }

    .achievement-count {
      font-size: 11px;
      color: var(--ink-soft);
    }

    .whisper-form {
      display: flex;
      gap: 8px;
    }

    .whisper-input {
      flex: 1;
      border: 2px solid var(--line-strong);
      padding: 6px 8px;
      font-size: 12px;
      font-family: var(--font-body);
    }

    .whisper-button {
      border: 2px solid var(--line-strong);
      background: var(--neon-magenta);
      color: #ffffff;
      padding: 6px 10px;
      font-weight: 700;
      cursor: pointer;
    }

    .whisper-list {
      display: grid;
      gap: 6px;
      max-height: 140px;
      overflow: auto;
    }

    .whisper-item {
      border: 2px solid var(--line-strong);
      background: var(--paper-warm);
      padding: 6px 8px;
      font-size: 11.5px;
    }

    .scene-inspector {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.85);
      display: none;
      align-items: flex-end;
      justify-content: center;
      padding: 16px;
      z-index: 5;
    }

    .scene-inspector.open {
      display: flex;
    }

    .scene-inspector-card {
      border: 3px solid var(--line-strong);
      background: #ffffff;
      padding: 14px 16px;
      box-shadow: var(--shadow-soft);
      max-width: 520px;
      width: min(100%, 520px);
      display: grid;
      gap: 10px;
    }

    .scene-inspector-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .scene-inspector-card h3 {
      margin: 0;
      font-size: 16px;
    }

    .scene-close {
      border: 2px solid var(--line-strong);
      background: var(--paper-warm);
      padding: 6px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
    }

    body.is-low .float-cube,
    body.is-low .scene-sky .cloud,
    body.is-low .leaf {
      animation: none;
    }

    body.is-low .scene-scanlines {
      opacity: 0;
    }

    body.is-low .scene-world::after {
      opacity: 0.1;
    }

    @keyframes drift {
      from { transform: translateX(-20px); }
      to { transform: translateX(40px); }
    }

    @keyframes leaf-drift {
      0% { transform: translate(-50%, -50%) translateX(0) rotate(0deg); }
      50% { transform: translate(-50%, -50%) translateX(calc(var(--wind) * 12px)) rotate(12deg); }
      100% { transform: translate(-50%, -50%) translateX(0) rotate(-6deg); }
    }

    @keyframes lantern-flicker {
      0%, 100% { opacity: 0.55; }
      50% { opacity: 0.9; }
    }

    @keyframes tornado-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes float {
      0%, 100% { transform: translate(-50%, -50%) translateY(0) rotate(10deg); }
      50% { transform: translate(-50%, -50%) translateY(-12px) rotate(-8deg); }
    }

    @keyframes hop {
      0% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -60%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes explode {
      0% { transform: translate(-50%, -50%) scale(1); }
      60% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes boom {
      from { opacity: 0.8; transform: scale(0.4); }
      to { opacity: 0; transform: scale(1.2); }
    }

    .hero {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 24px;
      align-items: stretch;
    }

    .hero-main {
      border: 3px solid var(--line-strong);
      background: var(--paper-warm);
      padding: clamp(18px, 3vw, 28px);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .hero-main::after {
      content: "";
      position: absolute;
      inset: -40% auto auto -20%;
      width: 320px;
      height: 320px;
      background: radial-gradient(circle, rgba(var(--neon-magenta-rgb), 0.25) 0%, transparent 65%);
      opacity: 0.7;
      pointer-events: none;
    }

    .eyebrow {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.32em;
      margin: 0 0 12px;
    }

    .hero h1 {
      margin: 0 0 12px;
      font-size: clamp(32px, 5vw, 56px);
      line-height: 1.02;
    }

    .hero .lede {
      margin: 0;
      color: var(--ink-muted);
      font-size: clamp(14px, 2vw, 18px);
      max-width: 50ch;
    }

    .hero-cta {
      margin-top: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .btn {
      border: 3px solid var(--line-strong);
      padding: 10px 16px;
      font-weight: 700;
      text-decoration: none;
      color: var(--ink);
      background: var(--paper);
      box-shadow: var(--shadow-tight);
      transition: transform 140ms ease, box-shadow 140ms ease;
    }

    .btn.primary {
      background: var(--neon-magenta);
      color: #fff;
      box-shadow: 0 0 0 rgba(var(--neon-magenta-rgb), 0.3);
    }

    .btn:hover {
      transform: translate(-2px, -2px);
      box-shadow: 10px 10px 0 rgba(0, 0, 0, 0.95);
    }

    .hero-side {
      display: grid;
      gap: 14px;
    }

    .note {
      border: 3px solid var(--line-strong);
      background: #fff;
      padding: 16px;
      box-shadow: var(--shadow-tight);
      position: relative;
    }

    .note h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .note p {
      margin: 0;
      font-size: 13px;
      color: var(--ink-muted);
    }

    .note .tag {
      position: absolute;
      right: 12px;
      top: -12px;
      background: var(--neon-magenta);
      color: #fff;
      border: 3px solid var(--line-strong);
      font-size: 11px;
      letter-spacing: 0.18em;
      padding: 4px 8px;
      text-transform: uppercase;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }

    .card {
      border: 3px solid var(--line-strong);
      background: var(--paper);
      padding: 16px;
      box-shadow: var(--shadow-tight);
      display: grid;
      gap: 10px;
      min-height: 180px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      left: 16px;
      top: 16px;
      width: 54px;
      height: 54px;
      border: 3px solid var(--line-strong);
      background: rgba(var(--neon-magenta-rgb), 0.18);
      transform: rotate(8deg);
    }

    .card h4 {
      margin: 0;
      font-size: 18px;
    }

    .card p {
      margin: 0;
      font-size: 13px;
      color: var(--ink-muted);
    }

    .card .step {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--neon-magenta);
    }

    .route {
      border: 3px solid var(--line-strong);
      background: var(--paper-warm);
      padding: 18px;
      box-shadow: var(--shadow-tight);
      display: grid;
      gap: 14px;
    }

    .route-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 14px;
      align-items: center;
    }

    .route-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid var(--line-strong);
      background: var(--neon-magenta);
      box-shadow: 0 0 0 6px rgba(var(--neon-magenta-rgb), 0.2);
    }

    .route h3 {
      margin: 0 0 6px;
    }

    .route p {
      margin: 0;
      color: var(--ink-soft);
      font-size: 13px;
    }

    .footer {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      align-items: start;
    }

    .footer .mono {
      font-family: var(--font-mono);
      font-size: 12px;
      border: 3px solid var(--line-strong);
      background: #fff;
      padding: 12px;
      box-shadow: var(--shadow-tight);
    }

    .logo {
      font-family: var(--font-logo);
      font-size: 28px;
      letter-spacing: 0.04em;
    }

    .pulse {
      display: inline-block;
      padding: 4px 10px;
      border: 3px solid var(--line-strong);
      background: rgba(var(--neon-magenta-rgb), 0.2);
      color: var(--neon-magenta);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 11px;
      animation: pulse 3.2s ease-in-out infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 rgba(var(--neon-magenta-rgb), 0.2); }
      50% { box-shadow: 0 0 24px rgba(var(--neon-magenta-rgb), 0.45); }
      100% { box-shadow: 0 0 0 rgba(var(--neon-magenta-rgb), 0.2); }
    }

    .reveal {
      animation: rise 720ms ease both;
    }
    .delay-1 { animation-delay: 80ms; }
    .delay-2 { animation-delay: 160ms; }
    .delay-3 { animation-delay: 240ms; }
    .delay-4 { animation-delay: 320ms; }

    @keyframes rise {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 980px) {
      .scene-body {
        grid-template-columns: 1fr;
      }
      .scene-side {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .hero { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      .footer { grid-template-columns: 1fr; }
    }

    @media (max-width: 720px) {
      .scene-actions {
        justify-content: flex-start;
      }
      .scene-viewport {
        height: 340px;
      }
      .scene-map {
        width: 140px;
        height: 140px;
      }
      .scene-telemetry {
        bottom: 12px;
      }
      .scene-status {
        font-size: 10px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .reveal,
      .float-cube,
      .scene-sky .cloud {
        animation: none !important;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <section class="scene reveal">
      <div class="scene-top">
        <div class="scene-brand">
          <div class="logo">cubixles_</div>
          <p>Drive the cubixle through a paper-world of proofs, routes, and signals. Each object is a prompt for the next move.</p>
        </div>
        <div class="scene-actions">
          <button class="scene-pill" id="sceneAudio" type="button">
            <span class="dot"></span>
            <span>Audio</span>
            <span class="state" id="sceneAudioState">Muted</span>
          </button>
          <button class="scene-pill is-on" id="sceneQuality" type="button">
            <span class="dot"></span>
            <span>Quality</span>
            <span class="state" id="sceneQualityState">High</span>
          </button>
          <button class="scene-pill" id="sceneRespawn" type="button">
            <span class="dot"></span>
            <span>Respawn</span>
          </button>
          <button class="scene-pill" id="sceneMapToggle" type="button">
            <span class="dot"></span>
            <span>Map</span>
            <span class="state" id="sceneMapState">Locked</span>
          </button>
          <button class="scene-pill is-on" id="sceneHelp" type="button">
            <span class="dot"></span>
            <span>Help</span>
          </button>
        </div>
      </div>

      <div class="scene-body">
        <div class="scene-viewport" id="sceneViewport">
          <div class="scene-sky">
            <span class="cloud" style="--x: 6%; --y: 14%; --w: 160px; --h: 40px; --speed: 28s;"></span>
            <span class="cloud" style="--x: 32%; --y: 8%; --w: 120px; --h: 34px; --speed: 24s;"></span>
            <span class="cloud" style="--x: 58%; --y: 18%; --w: 190px; --h: 44px; --speed: 30s;"></span>
            <span class="cloud" style="--x: 78%; --y: 10%; --w: 140px; --h: 36px; --speed: 26s;"></span>
            <span class="cloud" style="--x: 14%; --y: 28%; --w: 180px; --h: 42px; --speed: 34s;"></span>
            <span class="cloud" style="--x: 64%; --y: 30%; --w: 150px; --h: 38px; --speed: 32s;"></span>
            <div class="sun" id="sceneSun"></div>
            <div class="moon" id="sceneMoon"></div>
          </div>
          <div class="scene-world" id="sceneWorld" data-world-width="1400" data-world-height="900">
            <canvas class="scene-track" id="sceneTrackCanvas" width="1400" height="900"></canvas>
            <div class="terrain ridge" style="--x: 120px; --y: 80px; --w: 320px; --h: 140px; --r: -6deg;"></div>
            <div class="terrain ridge" style="--x: 820px; --y: 40px; --w: 360px; --h: 160px; --r: 8deg;"></div>
            <div class="terrain lake" style="--x: 480px; --y: 640px; --w: 260px; --h: 140px; --r: -10deg;"></div>
            <div class="terrain" style="--x: 980px; --y: 720px; --w: 280px; --h: 120px; --r: 4deg;"></div>
            <div class="water" style="--x: 660px; --y: 220px; --w: 220px; --h: 120px;"></div>
            <div class="grass-patch" style="--x: 360px; --y: 520px; --w: 220px; --h: 120px;"></div>
            <div class="grass-patch" style="--x: 1120px; --y: 680px; --w: 220px; --h: 130px;"></div>

            <svg class="road" viewBox="0 0 1400 900" preserveAspectRatio="none" aria-hidden="true">
              <path class="road-base" d="M 120 820 C 240 760 320 640 420 600 C 520 560 640 560 720 520 C 820 470 900 380 980 320 C 1060 260 1180 240 1280 180"></path>
              <path class="road-inner" d="M 120 820 C 240 760 320 640 420 600 C 520 560 640 560 720 520 C 820 470 900 380 980 320 C 1060 260 1180 240 1280 180"></path>
              <path class="road-lane" d="M 120 820 C 240 760 320 640 420 600 C 520 560 640 560 720 520 C 820 470 900 380 980 320 C 1060 260 1180 240 1280 180"></path>
            </svg>

            <div class="prop bench" style="--x: 300px; --y: 780px;"></div>
            <div class="prop bench" style="--x: 520px; --y: 420px;"></div>
            <div class="prop fence" style="--x: 420px; --y: 700px;"></div>
            <div class="prop fence" style="--x: 900px; --y: 480px;"></div>
            <div class="prop lantern" style="--x: 160px; --y: 680px;"></div>
            <div class="prop lantern" style="--x: 760px; --y: 500px;"></div>
            <div class="prop bricks" style="--x: 1040px; --y: 700px;"></div>
            <div class="prop signpost" style="--x: 640px; --y: 300px;"></div>
            <div class="prop tree" style="--x: 500px; --y: 160px;"></div>
            <div class="prop tree" style="--x: 1240px; --y: 360px;"></div>
            <div class="prop tree" style="--x: 1060px; --y: 100px;"></div>

            <div class="object billboard" data-id="skeptic" data-title="Skeptic Checklist" data-body="Verify the primitive: no custody, legible pricing, routed value. Drive here first." data-x="320" data-y="220">
              <span class="obj-label">Checklist</span>
            </div>
            <div class="object garage" data-id="builder" data-title="Builder Garage" data-body="Stage a one-face mint. Keep the originals, publish the context." data-x="220" data-y="720">
              <span class="obj-label">Garage</span>
            </div>
            <div class="object ramp" data-id="ramp" data-title="Mint Ramp" data-body="Boost into multi-face configurations. Curate, do not stack." data-x="820" data-y="610">
              <span class="obj-label">Ramp</span>
            </div>
            <div class="object relay" data-id="relay" data-title="Signal Relay" data-body="When you route value, the signal returns here. Check splits before you ship." data-x="580" data-y="360">
              <span class="obj-label">Relay</span>
            </div>
            <div class="object bridge" data-id="bridge" data-title="Provenance Bridge" data-body="Cross-collection adjacency becomes a tradable surface." data-x="940" data-y="160">
              <span class="obj-label">Bridge</span>
            </div>
            <div class="object tower" data-id="router" data-title="Value Router" data-body="Royalty forwarders live here. Audit where the flow goes." data-x="1140" data-y="520">
              <span class="obj-label">Router</span>
            </div>
            <div class="object crate" data-id="cache" data-title="Reference Cache" data-body="Small, legible proofs of context. Save your best six." data-x="980" data-y="760">
              <span class="obj-label">Cache</span>
            </div>
            <div class="object crate explosive" data-id="crate" data-title="Explosive Crate" data-body="Breaks open during storms. Inspects reveal a burst of proof." data-x="720" data-y="760">
              <span class="obj-label">Crate</span>
            </div>
            <div class="object billboard" data-id="summit" data-title="Far Ridge" data-body="Reach the ridge to unlock the full map." data-x="1160" data-y="260">
              <span class="obj-label">Summit</span>
            </div>
            <div class="object billboard" data-id="whisper" data-title="Whisper Grove" data-body="Leave a short note; the grove remembers the last few." data-x="420" data-y="420">
              <span class="obj-label">Whispers</span>
            </div>

            <div class="float-cube" style="--x: 520px; --y: 180px; --size: 26px; --delay: -1.2s;"></div>
            <div class="float-cube" style="--x: 720px; --y: 300px; --size: 34px; --delay: -2.4s;"></div>
            <div class="float-cube" style="--x: 420px; --y: 520px; --size: 30px; --delay: -0.8s;"></div>
            <div class="float-cube" style="--x: 1040px; --y: 380px; --size: 28px; --delay: -1.6s;"></div>

            <div class="tornado" id="sceneTornado" data-x="1020" data-y="300" style="--x: 1020px; --y: 300px;">
              <div class="core"></div>
            </div>

            <span class="leaf" style="--x: 240px; --y: 260px; --duration: 6s;"></span>
            <span class="leaf" style="--x: 360px; --y: 300px; --duration: 5s;"></span>
            <span class="leaf" style="--x: 520px; --y: 240px; --duration: 7s;"></span>
            <span class="leaf" style="--x: 680px; --y: 200px; --duration: 6.5s;"></span>
            <span class="leaf" style="--x: 820px; --y: 260px; --duration: 5.5s;"></span>
            <span class="leaf" style="--x: 980px; --y: 240px; --duration: 6.2s;"></span>
            <span class="leaf" style="--x: 1120px; --y: 220px; --duration: 5.8s;"></span>
            <span class="leaf" style="--x: 1240px; --y: 280px; --duration: 6.6s;"></span>

            <div class="player" id="scenePlayer"></div>
          </div>

          <div class="scene-light" id="sceneLight"></div>
          <div class="scene-fog" id="sceneFog"></div>
          <div class="scene-lightning" id="sceneLightning"></div>
          <canvas class="scene-fx" id="sceneFxCanvas"></canvas>

          <div class="scene-hud">
            <div class="scene-hint" id="sceneHint">Drive to a marker and press ENTER.</div>
            <div class="scene-speed" id="sceneSpeed">0 m/s</div>
            <div class="scene-toast" id="sceneToast"></div>
            <div class="scene-status" id="sceneStatus">Day 1 Â· Clear</div>
            <div class="scene-telemetry" id="sceneTelemetry">FPS 60</div>
            <div class="scene-map" id="sceneMap">
              <div class="map-label">map</div>
              <canvas id="sceneMapCanvas" width="180" height="180"></canvas>
            </div>
          </div>
          <div class="scene-scanlines"></div>
        </div>

        <aside class="scene-side">
          <div class="scene-panel" id="sceneControls">
            <h3>Controls</h3>
            <div class="control-grid">
              <span class="kbd">WASD</span> move
              <span class="kbd">ARROWS</span> move
              <span class="kbd">SHIFT</span> boost
              <span class="kbd">SPACE</span> hop
              <span class="kbd">ENTER</span> inspect
              <span class="kbd">M</span> map
              <span class="kbd">R</span> respawn
              <span class="kbd">L</span> audio
              <span class="kbd">T</span> weather
              <span class="kbd">N</span> time skip
              <span class="kbd">H</span> help
            </div>
            <div>Gimmick: boost through the ramp, then inspect the router. Storms unlock the crate.</div>
          </div>

          <div class="scene-panel">
            <h3>Achievements</h3>
            <div class="achievement" data-achievement="landmarks" data-target="4">
              <strong>Survey 4 landmarks</strong>
              <div class="achievement-bar"><span></span></div>
              <div class="achievement-count">0/4</div>
            </div>
            <div class="achievement" data-achievement="relay" data-target="1">
              <strong>Find the relay</strong>
              <div class="achievement-bar"><span></span></div>
              <div class="achievement-count">0/1</div>
            </div>
            <div class="achievement" data-achievement="summit" data-target="1">
              <strong>Reach the far ridge</strong>
              <div class="achievement-bar"><span></span></div>
              <div class="achievement-count">0/1</div>
            </div>
          </div>

          <div class="scene-panel">
            <h3>Whispers</h3>
            <form class="whisper-form" id="whisperForm">
              <input class="whisper-input" id="whisperInput" type="text" maxlength="60" placeholder="drop a note..." />
              <button class="whisper-button" type="submit">Send</button>
            </form>
            <div class="whisper-list" id="whisperList"></div>
          </div>
        </aside>
      </div>

      <div class="scene-inspector" id="sceneInspector" aria-hidden="true">
        <div class="scene-inspector-card">
          <div class="scene-inspector-head">
            <h3 id="sceneInspectorTitle">Marker</h3>
            <button class="scene-close" id="sceneInspectorClose" type="button">Close</button>
          </div>
          <p id="sceneInspectorBody"></p>
        </div>
      </div>
    </section>

    <section class="hero reveal">
      <div class="hero-main">
        <div class="pulse">where to go from here</div>
        <p class="eyebrow">cubixles_ world</p>
        <h1>Keep the originals. Route the context.</h1>
        <p class="lede">
          The world shows the primitive. This page shows the path: verify the
          claim, build your first cube, then publish a thesis that routes value
          to the works you reference.
        </p>
        <div class="hero-cta">
          <a class="btn primary" href="#">Start a 1-face mint</a>
          <a class="btn" href="#">Open the skeptic checklist</a>
        </div>
      </div>
      <div class="hero-side">
        <div class="note reveal delay-1">
          <div class="tag">Proof</div>
          <h3>No custody. No wrap.</h3>
          <p>Point at NFTs you own, mint a derivative, keep the originals.</p>
        </div>
        <div class="note reveal delay-2">
          <div class="tag">Signal</div>
          <h3>Scarcity as geometry.</h3>
          <p>Configuration, adjacency, and executed relations are the new rarity.</p>
        </div>
        <div class="note reveal delay-3">
          <div class="tag">Route</div>
          <h3>Value routing matters.</h3>
          <p>Mint-time payouts can flow to referenced works when compatible.</p>
        </div>
      </div>
    </section>

    <section class="grid">
      <article class="card reveal">
        <div class="step">STEP 01</div>
        <h4>Mint the smallest cube</h4>
        <p>Start with a one-face cube to verify the primitive with minimal cost.</p>
      </article>
      <article class="card reveal delay-1">
        <div class="step">STEP 02</div>
        <h4>Compose a thesis</h4>
        <p>Select six references that form a curatorial statement, not a stack.</p>
      </article>
      <article class="card reveal delay-2">
        <div class="step">STEP 03</div>
        <h4>Route value on-chain</h4>
        <p>Confirm where mint-time routing flows and keep the forwarder.</p>
      </article>
    </section>

    <section class="route reveal delay-2">
      <h3>Roadmap checks</h3>
      <div class="route-row">
        <div class="route-dot"></div>
        <div>
          <strong>Verify:</strong> inspect pricing math, routing splits, and no escrow.
          <p>Make sure the numbers are legible before you scale.</p>
        </div>
      </div>
      <div class="route-row">
        <div class="route-dot"></div>
        <div>
          <strong>Publish:</strong> write the story behind the configuration.
          <p>Context sells when the narrative is clear and grounded.</p>
        </div>
      </div>
      <div class="route-row">
        <div class="route-dot"></div>
        <div>
          <strong>Expand:</strong> link your cube into a larger provenance map.
          <p>Adjacency unlocks new markets without selling the originals.</p>
        </div>
      </div>
    </section>

    <section class="footer">
      <div class="mono reveal delay-3">
        <div class="logo">cubixles_</div>
        <p>Builder note: treat every cube as a market object with an explicit thesis.</p>
      </div>
      <div class="mono reveal delay-4">
        <strong>Quick links</strong>
        <p>builder docs / royalty routing / sample cubes / verifier checklist</p>
      </div>
    </section>
  </main>
  <script>
    (() => {
      const world = document.getElementById("sceneWorld");
      if (!world) return;

      const viewport = document.getElementById("sceneViewport");
      const player = document.getElementById("scenePlayer");
      const hint = document.getElementById("sceneHint");
      const speedEl = document.getElementById("sceneSpeed");
      const toastEl = document.getElementById("sceneToast");
      const mapBox = document.getElementById("sceneMap");
      const mapCanvas = document.getElementById("sceneMapCanvas");
      const mapCtx = mapCanvas.getContext("2d");
      const fxCanvas = document.getElementById("sceneFxCanvas");
      const fxCtx = fxCanvas ? fxCanvas.getContext("2d") : null;
      const trackCanvas = document.getElementById("sceneTrackCanvas");
      const trackCtx = trackCanvas ? trackCanvas.getContext("2d") : null;
      const lightLayer = document.getElementById("sceneLight");
      const fogLayer = document.getElementById("sceneFog");
      const lightningLayer = document.getElementById("sceneLightning");
      const sky = document.querySelector(".scene-sky");
      const sun = document.getElementById("sceneSun");
      const moon = document.getElementById("sceneMoon");
      const statusEl = document.getElementById("sceneStatus");
      const telemetryEl = document.getElementById("sceneTelemetry");
      const tornadoEl = document.getElementById("sceneTornado");

      const inspector = document.getElementById("sceneInspector");
      const inspectorTitle = document.getElementById("sceneInspectorTitle");
      const inspectorBody = document.getElementById("sceneInspectorBody");
      const inspectorClose = document.getElementById("sceneInspectorClose");

      const audioBtn = document.getElementById("sceneAudio");
      const audioState = document.getElementById("sceneAudioState");
      const qualityBtn = document.getElementById("sceneQuality");
      const qualityState = document.getElementById("sceneQualityState");
      const respawnBtn = document.getElementById("sceneRespawn");
      const mapBtn = document.getElementById("sceneMapToggle");
      const mapState = document.getElementById("sceneMapState");
      const helpBtn = document.getElementById("sceneHelp");
      const controlsPanel = document.getElementById("sceneControls");

      const whisperForm = document.getElementById("whisperForm");
      const whisperInput = document.getElementById("whisperInput");
      const whisperList = document.getElementById("whisperList");

      const worldW = Number.parseFloat(world.dataset.worldWidth) || 1400;
      const worldH = Number.parseFloat(world.dataset.worldHeight) || 900;

      const objects = [...document.querySelectorAll(".object[data-x]")].map((el) => {
        const x = Number.parseFloat(el.dataset.x);
        const y = Number.parseFloat(el.dataset.y);
        const id = el.dataset.id || "";
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        return {
          el,
          id,
          x,
          y,
          title: el.dataset.title || "Marker",
          body: el.dataset.body || "",
        };
      });

      const leafEls = [...document.querySelectorAll(".leaf")];
      leafEls.forEach((leaf) => {
        const base = Number.parseFloat(
          getComputedStyle(leaf).getPropertyValue("--duration")
        );
        leaf.dataset.baseDuration = String(base || 6);
      });

      const achievements = [...document.querySelectorAll(".achievement")].map((el) => ({
        el,
        key: el.dataset.achievement,
        target: Number.parseInt(el.dataset.target, 10) || 1,
        bar: el.querySelector(".achievement-bar span"),
        count: el.querySelector(".achievement-count"),
      }));

      const keys = new Set();
      const visited = new Set();
      let viewW = 0;
      let viewH = 0;
      let wantsInteract = false;
      let last = performance.now();
      let muted = true;
      let highQuality = true;
      let mapVisible = false;
      let mapLocked = true;
      let helpVisible = true;
      let hopTime = 0;
      let time = 0;
      let day = 1;
      let year = 1;
      const secondsPerDay = 90;
      const daysPerYear = 12;
      const seasonLabels = ["Spring", "Summer", "Autumn", "Winter"];
      let season = seasonLabels[0];
      let lastDay = day;
      const weatherModes = [
        { id: "clear", label: "Clear", wind: 0.35, rain: 0, snow: 0, fog: 0.08, storm: false },
        { id: "wind", label: "Wind", wind: 0.85, rain: 0, snow: 0, fog: 0.12, storm: false },
        { id: "rain", label: "Rain", wind: 0.6, rain: 1, snow: 0, fog: 0.35, storm: false },
        { id: "storm", label: "Storm", wind: 0.95, rain: 1.3, snow: 0, fog: 0.45, storm: true },
        { id: "snow", label: "Snow", wind: 0.4, rain: 0, snow: 1, fog: 0.3, storm: false },
        { id: "fog", label: "Fog", wind: 0.2, rain: 0, snow: 0, fog: 0.6, storm: false },
      ];
      let weatherIndex = 0;
      let weather = weatherModes[weatherIndex];
      let lightningTimer = 0;
      let fpsTimer = 0;
      let frames = 0;
      let fps = 0;
      let currentSpeed = 0;
      let audioCtx = null;
      let osc = null;
      let gain = null;

      const pos = { x: worldW * 0.52, y: worldH * 0.66 };
      const vel = { x: 0, y: 0 };
      let lastTrack = { x: pos.x, y: pos.y };

      const rainDrops = Array.from({ length: 180 }, () => ({
        x: Math.random(),
        y: Math.random(),
        speed: 0.6 + Math.random() * 1.2,
        length: 12 + Math.random() * 14,
      }));

      const snowFlakes = Array.from({ length: 140 }, () => ({
        x: Math.random(),
        y: Math.random(),
        speed: 0.2 + Math.random() * 0.5,
        size: 1 + Math.random() * 2,
      }));

      const zones = [
        { id: "yard", label: "Builder Yard", x: 80, y: 620, w: 320, h: 220 },
        { id: "relay", label: "Signal Flats", x: 420, y: 280, w: 360, h: 220 },
        { id: "ridge", label: "Far Ridge", x: 980, y: 120, w: 360, h: 220 },
        { id: "harbor", label: "Waterline", x: 520, y: 120, w: 360, h: 180 },
      ];
      let activeZone = null;

      const tornado = tornadoEl
        ? {
            x: Number.parseFloat(tornadoEl.dataset.x) || 1020,
            y: Number.parseFloat(tornadoEl.dataset.y) || 300,
            radius: 160,
          }
        : null;

      function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
      }

      function lerp(a, b, t) {
        return a + (b - a) * t;
      }

      function mixColor(a, b, t) {
        const r = Math.round(lerp(a[0], b[0], t));
        const g = Math.round(lerp(a[1], b[1], t));
        const bch = Math.round(lerp(a[2], b[2], t));
        return `rgb(${r}, ${g}, ${bch})`;
      }

      function resizeCanvas(canvas, ctx, width, height) {
        if (!canvas || !ctx) return;
        const dpr = Math.min(window.devicePixelRatio || 1, 2);
        canvas.width = Math.round(width * dpr);
        canvas.height = Math.round(height * dpr);
        canvas.style.width = `${width}px`;
        canvas.style.height = `${height}px`;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      function setSize() {
        viewW = viewport.clientWidth;
        viewH = viewport.clientHeight;
        resizeCanvas(fxCanvas, fxCtx, viewW, viewH);
        resizeCanvas(trackCanvas, trackCtx, worldW, worldH);
      }
      window.addEventListener("resize", setSize);
      setSize();

      function toast(message) {
        if (!toastEl) return;
        const div = document.createElement("div");
        div.className = "toast";
        div.textContent = message;
        toastEl.appendChild(div);
        setTimeout(() => div.remove(), 1800);
      }

      function updateAudioButton() {
        audioBtn.classList.toggle("is-on", !muted);
        audioState.textContent = muted ? "Muted" : "On";
      }

      function toggleAudio() {
        muted = !muted;
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          osc = audioCtx.createOscillator();
          gain = audioCtx.createGain();
          osc.type = "sine";
          osc.frequency.value = 60;
          gain.gain.value = 0.0;
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.start();
        }
        if (!muted) {
          audioCtx.resume?.();
          gain.gain.setTargetAtTime(0.02, audioCtx.currentTime, 0.08);
          toast("Audio on");
        } else {
          gain.gain.setTargetAtTime(0.0, audioCtx.currentTime, 0.08);
          toast("Audio muted");
        }
        updateAudioButton();
      }

      function toggleQuality() {
        highQuality = !highQuality;
        document.body.classList.toggle("is-low", !highQuality);
        qualityBtn.classList.toggle("is-on", highQuality);
        qualityState.textContent = highQuality ? "High" : "Low";
        if (fxCanvas) {
          fxCanvas.style.opacity = highQuality ? "1" : "0.5";
        }
        toast(`Quality ${highQuality ? "high" : "low"}`);
      }

      function updateLeafWind() {
        const windScale = Math.max(0.4, weather.wind);
        world.style.setProperty("--wind", windScale.toFixed(2));
        leafEls.forEach((leaf) => {
          const base = Number.parseFloat(leaf.dataset.baseDuration) || 6;
          const duration = Math.max(3, base / (0.4 + windScale));
          leaf.style.animationDuration = `${duration}s`;
        });
      }

      function setWeather(index, announce = true) {
        weatherIndex = (index + weatherModes.length) % weatherModes.length;
        weather = weatherModes[weatherIndex];
        updateLeafWind();
        if (fogLayer) {
          fogLayer.style.opacity = weather.fog.toString();
        }
        if (tornadoEl) {
          tornadoEl.classList.toggle("is-visible", weather.storm);
        }
        updateStatus();
        if (announce) {
          toast(`Weather ${weather.label}`);
        }
      }

      function cycleWeather() {
        setWeather(weatherIndex + 1);
      }

      function skipTime() {
        time = (time + secondsPerDay * 0.25) % secondsPerDay;
        toast("Time skip");
      }

      function toggleMap() {
        if (mapLocked) {
          toast("Map locked - reach the far ridge");
          return;
        }
        mapVisible = !mapVisible;
        mapBox.classList.toggle("is-visible", mapVisible);
        mapBtn.classList.toggle("is-on", mapVisible);
        mapState.textContent = mapVisible ? "On" : "Off";
      }

      function toggleHelp() {
        helpVisible = !helpVisible;
        controlsPanel.style.display = helpVisible ? "grid" : "none";
        helpBtn.classList.toggle("is-on", helpVisible);
      }

      function respawn() {
        pos.x = worldW * 0.52;
        pos.y = worldH * 0.66;
        vel.x = 0;
        vel.y = 0;
        toast("Respawned");
      }

      function updateStatus() {
        if (!statusEl) return;
        const zoneLabel = activeZone ? ` Â· ${activeZone.label}` : "";
        statusEl.textContent = `Day ${day} Â· Year ${year} Â· ${season} Â· ${weather.label}${zoneLabel}`;
      }

      function updateDayCycle(dt) {
        time += dt;
        if (time >= secondsPerDay) {
          time -= secondsPerDay;
          day += 1;
          if (day > daysPerYear) {
            day = 1;
            year += 1;
          }
        }

        if (day !== lastDay) {
          lastDay = day;
          const seasonIndex = Math.floor(((day - 1) / daysPerYear) * seasonLabels.length);
          const nextSeason = seasonLabels[Math.min(seasonLabels.length - 1, seasonIndex)];
          if (nextSeason !== season) {
            season = nextSeason;
            world.dataset.season = season.toLowerCase();
            toast(`${season} cycle`);
          }
          updateStatus();
        }

        const t = time / secondsPerDay;
        const daylight = Math.max(0, Math.sin((t - 0.25) * Math.PI * 2));
        const night = 1 - daylight;

        if (lightLayer) {
          const stormDim = weather.storm ? 0.22 : 0;
          lightLayer.style.opacity = (night * 0.6 + stormDim).toFixed(2);
        }

        if (fogLayer) {
          const fogStrength = Math.min(0.85, weather.fog + night * 0.18);
          fogLayer.style.opacity = fogStrength.toFixed(2);
        }

        if (sky) {
          const top = mixColor([26, 30, 44], [255, 255, 255], daylight);
          const mid = mixColor([44, 50, 70], [254, 244, 236], daylight);
          const bottom = mixColor([58, 58, 72], [255, 255, 255], daylight * 0.9);
          sky.style.setProperty("--sky-top", top);
          sky.style.setProperty("--sky-mid", mid);
          sky.style.setProperty("--sky-bottom", bottom);
        }

        if (sun && moon) {
          const angle = t * Math.PI * 2;
          const sunX = 50 + Math.cos(angle - Math.PI / 2) * 42;
          const sunY = 70 - Math.sin(angle - Math.PI / 2) * 52;
          sun.style.left = `${sunX}%`;
          sun.style.top = `${sunY}%`;
          sun.style.opacity = daylight.toFixed(2);

          const moonAngle = angle + Math.PI;
          const moonX = 50 + Math.cos(moonAngle - Math.PI / 2) * 42;
          const moonY = 70 - Math.sin(moonAngle - Math.PI / 2) * 52;
          moon.style.left = `${moonX}%`;
          moon.style.top = `${moonY}%`;
          moon.style.opacity = night.toFixed(2);
        }
      }

      function updateZone() {
        const zone = zones.find(
          (z) =>
            pos.x >= z.x &&
            pos.x <= z.x + z.w &&
            pos.y >= z.y &&
            pos.y <= z.y + z.h
        );
        if ((zone && !activeZone) || (zone && activeZone && zone.id !== activeZone.id) || (!zone && activeZone)) {
          activeZone = zone || null;
          if (activeZone) {
            toast(`Zone ${activeZone.label}`);
          }
          updateStatus();
        }
      }

      function updateTelemetry(dt) {
        frames += 1;
        fpsTimer += dt;
        if (fpsTimer >= 0.6) {
          fps = Math.round(frames / fpsTimer);
          fpsTimer = 0;
          frames = 0;
        }
        if (telemetryEl) {
          const zoneLabel = activeZone ? activeZone.label : "Open";
          telemetryEl.textContent = `FPS ${fps} Â· Wind ${weather.wind.toFixed(1)} Â· ${zoneLabel}`;
        }
      }

      function drawTracks() {
        if (!trackCtx) return;
        trackCtx.fillStyle = "rgba(249, 239, 230, 0.02)";
        trackCtx.fillRect(0, 0, worldW, worldH);
        trackCtx.strokeStyle = `rgba(210, 83, 83, ${Math.min(0.2, 0.06 + currentSpeed / 600)})`;
        trackCtx.lineWidth = currentSpeed > 160 ? 3.5 : 2.2;
        trackCtx.beginPath();
        trackCtx.moveTo(lastTrack.x, lastTrack.y);
        trackCtx.lineTo(pos.x, pos.y);
        trackCtx.stroke();
        lastTrack = { x: pos.x, y: pos.y };
      }

      function drawWeather(dt) {
        if (!fxCtx) return;
        fxCtx.clearRect(0, 0, viewW, viewH);
        const windShift = (weather.wind - 0.35) * 35;
        const rainCount = highQuality ? rainDrops.length : Math.floor(rainDrops.length * 0.45);
        const snowCount = highQuality ? snowFlakes.length : Math.floor(snowFlakes.length * 0.45);

        if (weather.rain > 0) {
          fxCtx.strokeStyle = "rgba(210, 83, 83, 0.25)";
          fxCtx.lineWidth = 1.4;
          for (let i = 0; i < rainCount; i += 1) {
            const drop = rainDrops[i];
            drop.y += drop.speed * dt * weather.rain * 1.2;
            drop.x += windShift * dt * 0.002;
            if (drop.y > 1) {
              drop.y = -0.2;
              drop.x = Math.random();
            }
            if (drop.x > 1) drop.x = 0;
            if (drop.x < 0) drop.x = 1;
            const x = drop.x * viewW;
            const y = drop.y * viewH;
            const len = drop.length * (0.8 + weather.rain);
            fxCtx.beginPath();
            fxCtx.moveTo(x, y);
            fxCtx.lineTo(x + windShift * 0.4, y + len);
            fxCtx.stroke();
          }
        }

        if (weather.snow > 0) {
          fxCtx.fillStyle = "rgba(255, 255, 255, 0.8)";
          for (let i = 0; i < snowCount; i += 1) {
            const flake = snowFlakes[i];
            flake.y += flake.speed * dt * weather.snow * 0.9;
            flake.x += windShift * dt * 0.004;
            if (flake.y > 1) {
              flake.y = -0.1;
              flake.x = Math.random();
            }
            if (flake.x > 1) flake.x = 0;
            if (flake.x < 0) flake.x = 1;
            const x = flake.x * viewW;
            const y = flake.y * viewH;
            fxCtx.beginPath();
            fxCtx.arc(x, y, flake.size, 0, Math.PI * 2);
            fxCtx.fill();
          }
        }

        if (weather.wind > 0.6 && weather.rain === 0 && weather.snow === 0) {
          fxCtx.strokeStyle = "rgba(210, 83, 83, 0.18)";
          fxCtx.lineWidth = 1;
          const streaks = highQuality ? 40 : 16;
          for (let i = 0; i < streaks; i += 1) {
            const y = (i / streaks) * viewH + (windShift % 40);
            fxCtx.beginPath();
            fxCtx.moveTo(0, y);
            fxCtx.lineTo(viewW, y + windShift * 0.1);
            fxCtx.stroke();
          }
        }
      }

      function updateLightning(dt) {
        if (!lightningLayer) return;
        if (weather.storm && Math.random() < dt * 0.8) {
          lightningTimer = 0.18 + Math.random() * 0.12;
        }
        if (lightningTimer > 0) {
          lightningTimer = Math.max(0, lightningTimer - dt);
          const intensity = Math.min(1, lightningTimer * 5);
          lightningLayer.style.opacity = intensity.toFixed(2);
        } else {
          lightningLayer.style.opacity = "0";
        }
      }

      function applyTornado(dt) {
        if (!tornado || !tornadoEl || !weather.storm) {
          if (tornadoEl) tornadoEl.classList.remove("is-active");
          return;
        }
        const dx = pos.x - tornado.x;
        const dy = pos.y - tornado.y;
        const dist = Math.hypot(dx, dy);
        if (dist < tornado.radius) {
          const force = (1 - dist / tornado.radius) * 220;
          const nx = dx / (dist || 1);
          const ny = dy / (dist || 1);
          vel.x += -ny * force * dt;
          vel.y += nx * force * dt;
          tornadoEl.classList.add("is-active");
        } else {
          tornadoEl.classList.remove("is-active");
        }
      }

      function explodeCrate(obj) {
        if (obj.el.dataset.exploded === "true") return;
        obj.el.dataset.exploded = "true";
        obj.el.classList.add("is-exploding");
        setTimeout(() => obj.el.classList.remove("is-exploding"), 420);
        const dx = pos.x - obj.x;
        const dy = pos.y - obj.y;
        const dist = Math.max(1, Math.hypot(dx, dy));
        const force = 240 * (1 - Math.min(dist / 140, 1));
        vel.x += (dx / dist) * force;
        vel.y += (dy / dist) * force;
        toast("Crate burst");
      }

      function handleInteraction(obj) {
        if (obj.el.classList.contains("explosive")) {
          if (weather.storm) {
            explodeCrate(obj);
          } else {
            toast("Crate sleeps until storm");
          }
        }
        openInspector(obj);
        markVisited(obj);
        if (obj.id === "whisper") {
          whisperInput.focus();
        }
      }

      function openInspector(obj) {
        inspectorTitle.textContent = obj.title;
        inspectorBody.textContent = obj.body;
        inspector.classList.add("open");
        inspector.setAttribute("aria-hidden", "false");
      }

      function closeInspector() {
        inspector.classList.remove("open");
        inspector.setAttribute("aria-hidden", "true");
      }

      function markVisited(obj) {
        if (!obj.id || visited.has(obj.id)) return;
        visited.add(obj.id);
        obj.el.classList.add("is-visited");
        updateAchievements();
        toast(`Logged ${obj.title}`);
        if (obj.id === "summit") {
          mapLocked = false;
          mapVisible = true;
          mapBox.classList.add("is-visible");
          mapBtn.classList.add("is-on");
          mapState.textContent = "On";
          toast("Map unlocked");
        }
      }

      function updateAchievements() {
        const visitedCount = visited.size;
        achievements.forEach((item) => {
          let current = 0;
          if (item.key === "landmarks") {
            current = Math.min(visitedCount, item.target);
          } else {
            current = visited.has(item.key) ? 1 : 0;
          }
          const pct = Math.round((current / item.target) * 100);
          if (item.bar) item.bar.style.width = `${pct}%`;
          if (item.count) item.count.textContent = `${current}/${item.target}`;
        });
      }

      function drawMap() {
        if (!mapVisible) return;
        if (!mapCtx) return;
        const w = mapCanvas.width;
        const h = mapCanvas.height;
        mapCtx.clearRect(0, 0, w, h);
        mapCtx.fillStyle = "rgba(255,255,255,0.95)";
        mapCtx.fillRect(0, 0, w, h);
        mapCtx.strokeStyle = "rgba(0,0,0,0.5)";
        mapCtx.lineWidth = 2;
        mapCtx.strokeRect(8, 8, w - 16, h - 16);

        const scaleX = (w - 20) / worldW;
        const scaleY = (h - 20) / worldH;
        const offsetX = 10;
        const offsetY = 10;

        objects.forEach((obj) => {
          const x = offsetX + obj.x * scaleX;
          const y = offsetY + obj.y * scaleY;
          mapCtx.fillStyle = visited.has(obj.id) ? "rgba(210,83,83,0.9)" : "rgba(0,0,0,0.5)";
          mapCtx.fillRect(x - 2, y - 2, 4, 4);
        });

        const px = offsetX + pos.x * scaleX;
        const py = offsetY + pos.y * scaleY;
        mapCtx.fillStyle = "rgba(210,83,83,1)";
        mapCtx.beginPath();
        mapCtx.arc(px, py, 4, 0, Math.PI * 2);
        mapCtx.fill();
      }

      function updatePlayer(dt) {
        const boost = keys.has("ShiftLeft") || keys.has("ShiftRight");
        const accel = boost ? 820 : 560;
        const maxSpeed = boost ? 320 : 220;

        if (keys.has("KeyW") || keys.has("ArrowUp")) vel.y -= accel * dt;
        if (keys.has("KeyS") || keys.has("ArrowDown")) vel.y += accel * dt;
        if (keys.has("KeyA") || keys.has("ArrowLeft")) vel.x -= accel * dt;
        if (keys.has("KeyD") || keys.has("ArrowRight")) vel.x += accel * dt;

        const speed = Math.hypot(vel.x, vel.y);
        currentSpeed = speed;
        if (speed > maxSpeed) {
          const scale = maxSpeed / speed;
          vel.x *= scale;
          vel.y *= scale;
        }

        vel.x *= Math.pow(0.82, dt * 60);
        vel.y *= Math.pow(0.82, dt * 60);

        pos.x = clamp(pos.x + vel.x * dt, 40, worldW - 40);
        pos.y = clamp(pos.y + vel.y * dt, 40, worldH - 40);

        if (hopTime > 0) {
          hopTime = Math.max(0, hopTime - dt);
        }
        const hop = hopTime > 0 ? Math.sin((1 - hopTime / 0.3) * Math.PI) * 10 : 0;
        const hopScale = hopTime > 0 ? 1 + hop / 80 : 1;

        const angle = Math.atan2(vel.y, vel.x) + Math.PI / 2;
        player.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0) translate(-50%, -50%) translateY(${-hop}px) rotate(${angle}rad) scale(${hopScale})`;
        player.classList.toggle("is-boost", boost && speed > 40);
        speedEl.textContent = `${Math.round(speed)} m/s`;

        if (audioCtx && osc && gain && !muted) {
          const targetHz = 45 + Math.min(140, speed) + weather.wind * 8;
          osc.frequency.setTargetAtTime(targetHz, audioCtx.currentTime, 0.08);
        }
      }

      function updateCamera() {
        const halfW = viewW / 2;
        const halfH = viewH / 2;
        const maxX = Math.max(halfW, worldW - halfW);
        const maxY = Math.max(halfH, worldH - halfH);
        const camX = clamp(pos.x, halfW, maxX);
        const camY = clamp(pos.y, halfH, maxY);
        world.style.transform = `translate3d(${halfW - camX}px, ${halfH - camY}px, 0)`;
      }

      function updateInteraction() {
        let nearest = null;
        let best = Infinity;
        objects.forEach((obj) => {
          const d = Math.hypot(pos.x - obj.x, pos.y - obj.y);
          obj.el.classList.toggle("is-near", d < 90);
          if (d < 90 && d < best) {
            best = d;
            nearest = obj;
          }
        });

        if (nearest) {
          hint.textContent = `Press ENTER to inspect ${nearest.title}`;
          hint.classList.add("is-visible");
        } else {
          hint.classList.remove("is-visible");
        }

        if (nearest && wantsInteract && !inspector.classList.contains("open")) {
          wantsInteract = false;
          handleInteraction(nearest);
        }
      }

      function step(now) {
        const dt = Math.min(0.032, (now - last) / 1000);
        last = now;

        updateDayCycle(dt);

        if (!inspector.classList.contains("open")) {
          updatePlayer(dt);
          applyTornado(dt);
        }
        updateZone();
        updateCamera();
        updateInteraction();
        drawTracks();
        drawWeather(dt);
        updateLightning(dt);
        updateTelemetry(dt);
        drawMap();

        requestAnimationFrame(step);
      }

      audioBtn.addEventListener("click", toggleAudio);
      qualityBtn.addEventListener("click", toggleQuality);
      respawnBtn.addEventListener("click", respawn);
      mapBtn.addEventListener("click", toggleMap);
      helpBtn.addEventListener("click", toggleHelp);

      inspectorClose.addEventListener("click", closeInspector);
      inspector.addEventListener("click", (event) => {
        if (event.target === inspector) closeInspector();
      });

      window.addEventListener("keydown", (event) => {
        if (["INPUT", "TEXTAREA"].includes(document.activeElement?.tagName)) return;
        keys.add(event.code);

        if (event.code === "Enter") wantsInteract = true;
        if (event.code === "KeyR") respawn();
        if (event.code === "KeyM") toggleMap();
        if (event.code === "KeyL") toggleAudio();
        if (event.code === "KeyH") toggleHelp();
        if (event.code === "KeyT") cycleWeather();
        if (event.code === "KeyN") skipTime();
        if (event.code === "Space") {
          hopTime = 0.3;
        }
      });

      window.addEventListener("keyup", (event) => {
        keys.delete(event.code);
        if (event.code === "Enter") wantsInteract = false;
        if (event.code === "Escape" && inspector.classList.contains("open")) closeInspector();
      });

      let whispers = [];
      try {
        whispers = JSON.parse(localStorage.getItem("cubixlesWhispers") || "[]");
      } catch {
        whispers = [];
      }

      function renderWhispers() {
        whisperList.innerHTML = "";
        whispers.slice(0, 6).forEach((text) => {
          const item = document.createElement("div");
          item.className = "whisper-item";
          item.textContent = text;
          whisperList.appendChild(item);
        });
      }

      whisperForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const value = whisperInput.value.trim();
        if (!value) return;
        whispers.unshift(value);
        whispers = whispers.slice(0, 6);
        localStorage.setItem("cubixlesWhispers", JSON.stringify(whispers));
        whisperInput.value = "";
        renderWhispers();
        toast("Whisper added");
      });

      updateAudioButton();
      world.dataset.season = season.toLowerCase();
      setWeather(weatherIndex, false);
      updateAchievements();
      renderWhispers();
      hint.classList.remove("is-visible");
      requestAnimationFrame(step);
    })();
  </script>
</body>
</html>
