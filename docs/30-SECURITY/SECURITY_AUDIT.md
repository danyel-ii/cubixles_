# cubixles_ — Security & Edge-Case Coverage Review

Last updated: 2026-01-02
Date: 2026-01-02

## Scope
- Contracts: `CubixlesMinter`, `RoyaltySplitter`
- Tests: unit, fuzz, invariants, edge cases, fork harness
- Tooling: Slither + Solhint configs, CI workflow, client secret scan

## Implemented artifacts
- Docs: `docs/30-SECURITY/THREAT_MODEL.md`, `docs/30-SECURITY/INVARIANTS.md`, `docs/30-SECURITY/KNOWN_LIMITATIONS.md`, `docs/30-SECURITY/STATIC_ANALYSIS.md`, `docs/30-SECURITY/SECURITY_RUNBOOK.md`, `docs/30-SECURITY/FORK_TESTING.md`
- CI: `.github/workflows/ci.yml`
- Static analysis config: `contracts/.solhint.json`, `contracts/slither.config.json`
- Mocks: `contracts/test/mocks/MockERC721s.sol`, `contracts/test/mocks/Receivers.sol`
- Edge tests: `contracts/test/CubixlesMinterEdge.t.sol`, updates to `contracts/test/RoyaltySplitter.t.sol`
- Fuzz tests: `contracts/test/fuzz/CubixlesMinterFuzz.t.sol`
- Invariants: `contracts/test/invariants/CubixlesMinterInvariants.t.sol`
- Fork tests: `contracts/test/fork/MainnetFork.t.sol`
- Endpoint hardening: nonce + signature auth, rate limits, Zod validation, size caps, safe logging
- Client secret scan: `scripts/check-client-secrets.mjs`

## Policy decisions captured
- Receiver failure policy is strict: mint/royalty transfers revert on failed ETH or token transfer.
- `ownerOf` revert or mismatch causes mint revert.
- Refund exactness: `msg.value - currentMintPrice()` is returned to minter.
- RoyaltySplitter splits $LESS 50% to burn address and 50% to owner on swap success, then forwards remaining ETH to owner.

## Test results
### Unit + edge + fuzz + invariants
Command:
```sh
cd contracts
forge test -vvv
```
Result: PASS (81 tests).

### Coverage (Solidity)
Command:
```sh
npm run coverage:contracts
```
Result: **Not rerun in this audit**. Previous snapshot was 90.67% line coverage (minimum is 90%).
- Report: generated by `npm run coverage:contracts` (grouped by contract).
- Excluded: `contracts/script/**` from the coverage gate.
- Action: keep coverage at or above 90% before mainnet release.

### Invariants (standalone run)
Command:
```sh
cd contracts
forge test --match-path "test/invariants/*" -vvv
```
Result: PASS (3 tests, 128k handler calls)

### Fork tests (mainnet)
Command:
```sh
export MAINNET_RPC_URL="https://your-mainnet-rpc"
export FORK_BLOCK_NUMBER=19000000
export NO_PROXY="*"
export HTTP_PROXY=""
export HTTPS_PROXY=""
npm run fork-test
```
Result: PASS (2 tests)
- `ownerOf` reverted (non-standard or restricted), logged and allowed.
- `royaltyInfo` reverted (non-ERC2981 or restricted), logged and allowed.

### Frontend tests
Command:
```sh
npm test
```
Result: PASS (22 tests, Vitest unit/component/API; v4.0.16).

### Frontend smoke (Playwright)
Command:
```sh
npm run test:ui
```
Result: **Not rerun in this audit**.
- Mocked E2E specs (`tests/e2e/*`) added but not run in this snapshot.

### Client secret scan
Command:
```sh
npm run check:no-client-secrets
```
Result: **Not rerun in this audit**.

### Abuse checks (pin endpoint)
Command:
```sh
npm run dev -- --port 3010
```
Results (local):
- Size cap: `POST /api/pin/metadata` with ~60KB body → `413 Payload too large`.
- Rate limit: 5 requests in quick succession → `429 Rate limit exceeded` after the 4th allowed request (capacity 5, refill 0.5/sec).
- Invalid payloads return `400` before signature checks as expected.

## Static analysis
- Local solhint run:
  - Command: `cd contracts && npx solhint "src/**/*.sol"`
  - Result: 0 errors, 37 warnings (import-path-check + lint warnings).
- Local slither run:
  - Command: `cd contracts && slither .`
  - Result: 2 findings (weak PRNG; naming convention).

## Failures observed (triage)
- None in this audit run.

## Notable risks (triaged)
1. **External dependency risk**
   - `ownerOf` calls to referenced ERC-721 contracts can revert or lie. Mitigation: strict revert policy; mint fails safely.
   - Uniswap v4 PoolManager swaps are external and hook-dependent. Mitigation: swap can be disabled; fallback sends ETH to owner; slippage cap enforced.
2. **Deterministic tokenId collisions**
   - TokenId is deterministic and depends on `salt`. Mitigation: commit-reveal prevents third-party frontruns; UI must generate strong random salts.
3. **Centralization risks**
   - Owner can change royalty receiver and swap configuration. Mitigation: recommend multisig and optional timelock for production owners.
4. **API dependency risks**
   - Pinata/Alchemy/Neynar availability impacts UX. Mitigation: monitor health, alert on failures, keep manual fallback guidance.
5. **Rate-limit fallback**
   - In-memory fallback during Redis outages can be bypassed. Mitigation: add an optional fail-closed mode and monitoring.

## Notes
- Fork tests are optional; they skip unless `MAINNET_RPC_URL` is provided.
- Release gate uses `npm run fork-test` with a pinned block via `FORK_BLOCK_NUMBER`.
- CI includes `forge test`, `solhint`, `slither`, coverage (90% minimum), and client secret scan gates.
- `npm audit --json` reports 0 vulnerabilities after upgrading Vitest to v4.0.16.
